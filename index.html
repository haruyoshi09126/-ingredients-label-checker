<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>成分チェッカー</title>
  <style>
    body{font-family:sans-serif;max-width:700px;margin:20px auto;padding:0 10px;}
    textarea{width:100%;height:100px;}
    button{padding:6px 12px;margin:8px 0;}
    .pill{display:inline-block;padding:2px 8px;border-radius:12px;margin:2px;font-size:0.9em;}
    .bad{background:#f88;color:#fff;}
    .warn{background:#fd8;color:#000;}
    .ok{background:#8d8;color:#000;}
    .safe{background:#8cf;color:#000;}
    .unknown{background:#ccc;color:#000;}
    .note{font-size:0.8em;color:#555;margin-left:10px;}
    .muted{color:#666;font-size:0.9em;}
    .score{font-weight:bold;font-size:1.2em;}
  </style>
</head>
<body>
<h2>成分チェッカー</h2>
<p>成分表を入力して「判定」ボタンを押してください。</p>
<textarea id="ingredients"></textarea><br>
<button id="analyze">判定</button>

<div id="result"></div>

<script>
/* ===== 判定ルール ===== */
const RULES = [
  { id:'parabens', patterns:[/(\w+)?paraben/i,/パラベン/i,/メチルパラベン/i,/プロピルパラベン/i], severity:'bad', tags:['防腐剤'], notes:'パラベン系防腐剤。子ども用途では避けたい場合が多い。' },
  { id:'phenoxyethanol', patterns:[/phenoxyethanol/i,/フェノキシエタノール/i], severity:'warn', tags:['防腐剤'], notes:'一般的な防腐剤。高配合は刺激になりうる。' },
  { id:'fragrance', patterns:[/fragrance/i,/parfum/i,/香料/i], severity:'warn', tags:['香料'], notes:'乳幼児環境では無香料推奨。' },
  { id:'allergen_fragrances', patterns:[/linalool/i,/limonene/i,/citral/i,/citronellol/i,/geraniol/i,/eugenol/i], severity:'warn', tags:['香料アレルゲン'], notes:'EU表示対象の香料アレルゲン。' },
  { id:'sulfates', patterns:[/sodium\s+lauryl\s+sulfate/i,/SLS\b/i,/sodium\s+laureth\s+sulfate/i,/SLES\b/i,/ラウリル硫酸/i,/ラウレス硫酸/i], severity:'warn', tags:['界面活性剤'], notes:'高洗浄の硫酸塩系。' },
  { id:'alcohol', patterns:[/alcohol\b/i,/エタノール/i], severity:'warn', tags:['溶剤'], notes:'高配合は乾燥/刺激の可能性。' },
  { id:'bha_bht', patterns:[/\bBHA\b/i,/\bBHT\b/i], severity:'warn', tags:['酸化防止剤'], notes:'敏感肌では刺激感の報告あり。' },
  { id:'glycerin', patterns:[/glycerin/i,/グリセリン/i], severity:'ok', tags:['保湿'], notes:'保湿の基本成分。' },
  { id:'bg', patterns:[/\bBG\b/i,/ブチレングリコール/i,/butylene\s+glycol/i], severity:'ok', tags:['保湿/溶媒'], notes:'一般的。' }
];

/* ===== 無害リスト（SAFE_LIST） ===== */
const SAFE_LIST = [
  /水/i,
  /クエン酸/i,
  /クエン酸Na/i,
  /塩化Na/i,
  /炭酸水素Na/i,
  /グリセリン/i,
  /\bBG\b/i,
  /ブチレングリコール/i,
  /プロパンジオール/i,
  /ソルビトール/i,
  /トコフェロール/i,
  /アスコルビン酸/i,
  /アロエ/i,
  /カミツレ/i,
  /シア脂/i,
  /ヒアルロン酸/i,
  /アラニン/i,
  /グリシン/i,
  /セリン/i
];

/* ===== 判定処理 ===== */
const analyzeBtn = document.getElementById('analyze');
const resultEl = document.getElementById('result');

analyzeBtn.onclick = () => {
  const text = document.getElementById('ingredients').value||'';
  const tokens = tokenize(text);

  if(!tokens.length){
    resultEl.innerHTML = '<div class="muted">成分が空です。</div>';
    return;
  }

  const hits = matchRules(tokens);
  const bestByToken = new Map();
  const rank = {bad:3,warn:2,ok:1};
  for(const h of hits){
    const prev = bestByToken.get(h.token);
    if(!prev || rank[h.rule.severity] > rank[prev.rule.severity]) {
      bestByToken.set(h.token, h);
    }
  }

  // SAFE_LIST と UNKNOWN を追加
  tokens.forEach(tok=>{
    if(bestByToken.has(tok)) return;
    if(SAFE_LIST.some(r=> r.test(tok))){
      bestByToken.set(tok, {token:tok, rule:{severity:'safe', notes:'一般的に無害とされる成分', tags:['無害']}});
    } else {
      bestByToken.set(tok, {token:tok, rule:{severity:'unknown', notes:'データベース未登録（評価なし）', tags:['不明']}});
    }
  });

  const sum = summarize([...bestByToken.values()]);
  const color = sum.worst==='bad'?'#f88':(sum.worst==='warn'?'#fd8':'#8d8');

  const line = tokens.map(tok => {
    const hit = bestByToken.get(tok);
    return hit ? badge(tok, hit.rule.severity) : `<span class="pill">${escapeHtml(tok)}</span>`;
  }).join(' ');

  const details = [...bestByToken.values()].map(h=>`
    <li><strong>${escapeHtml(h.token)}</strong>：
      <span class="pill ${h.rule.severity}">${label(h.rule.severity)}</span>
      <div class="note">${escapeHtml(h.rule.notes)} <em>（${h.rule.tags.join(' / ')}）</em></div>
    </li>`).join('');

  resultEl.innerHTML = `
    <div style="border-left:6px solid ${color};padding-left:10px">
      <div class="score">総合判定：${label(sum.worst)}</div>
      <div class="muted">ヒット数：要注意 ${sum.counts.bad} / 注意 ${sum.counts.warn} / OK ${sum.counts.ok} / 無害 ${sum.counts.safe} / 不明 ${sum.counts.unknown}</div>
    </div>
    <div style="margin:10px 0">${line}</div>
    <h4>成分内訳</h4><ul>${details}</ul>
  `;
};

/* ===== 共通関数 ===== */
function tokenize(text){
  return text.replace(/[、・]/g,',').replace(/\s+/g,' ').split(/[,;｜\n]/).map(s=>s.trim()).filter(Boolean);
}
function matchRules(tokens){
  const hits = [];
  tokens.forEach(tok=>{
    for(const r of RULES){
      if(r.patterns.some(p => p.test(tok))){
        hits.push({token:tok, rule:r});
      }
    }
  });
  return hits;
}
function summarize(hits){
  const rank = {bad:3,warn:2,ok:1,safe:0,unknown:0};
  let worst='ok';
  const counts={bad:0,warn:0,ok:0,safe:0,unknown:0};
  hits.forEach(h=>{
    counts[h.rule.severity] = (counts[h.rule.severity]||0)+1;
    if(rank[h.rule.severity]>rank[worst]) worst=h.rule.severity;
  });
  return {worst,counts};
}
function label(sev){
  switch(sev){
    case 'bad': return '要注意';
    case 'warn': return '注意';
    case 'ok': return 'OK';
    case 'safe': return '無害';
    case 'unknown': return '不明';
    default: return sev;
  }
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function badge(text, sev){
  return `<span class="pill ${sev}">${escapeHtml(text)}</span>`;
}
</script>
</body>
</html>
